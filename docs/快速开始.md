# 后端快速开始指南

## 📋 准备工作

### 1. 获取通义千问API Key

1. 访问 https://dashscope.aliyuncs.com/
2. 使用阿里云账号登录（没有的话需要注册）
3. 进入控制台，找到"API Key管理"
4. 创建新的API Key（免费用户有一定额度）
5. 复制API Key（格式：`sk-xxxxxxxxxx`）

### 2. 配置环境变量

创建 `.env` 文件（在backend目录下）：

```bash
# Windows命令
copy env_example.txt .env
```

编辑 `.env` 文件，填入API Key：

```
DASHSCOPE_API_KEY=sk-你的API_Key
HOST=0.0.0.0
PORT=8000
```

## 🚀 启动服务

### 方法一：使用一键启动脚本（推荐）

```bash
# Windows
双击 start.bat

# 或在命令行运行
start.bat
```

### 方法二：手动启动

```bash
# 1. 创建虚拟环境
python -m venv venv

# 2. 激活虚拟环境
venv\Scripts\activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 启动服务
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## ✅ 验证服务

服务启动后，打开浏览器访问：

### 1. API文档（推荐）
http://localhost:8000/docs

在这个页面可以：
- 查看所有API接口
- 直接测试API
- 查看请求/响应格式

### 2. 健康检查
http://localhost:8000/health

应该看到：
```json
{
  "status": "ok",
  "api_key_configured": true
}
```

如果 `api_key_configured` 为 `false`，说明API Key未正确配置。

## 🧪 测试API

### 方法一：使用Swagger UI（推荐）

1. 访问 http://localhost:8000/docs
2. 找到 `POST /api/food/analyze` 接口
3. 点击 "Try it out"
4. 输入：
   ```json
   {
     "food_name": "番茄炒蛋"
   }
   ```
5. 点击 "Execute"
6. 查看响应结果

### 方法二：使用测试脚本

```bash
# 确保已安装requests
pip install requests

# 运行测试脚本
python test_api.py
```

### 方法三：使用curl

```bash
curl -X POST http://localhost:8000/api/food/analyze \
  -H "Content-Type: application/json" \
  -d "{\"food_name\": \"番茄炒蛋\"}"
```

## 📱 连接Android

### 使用模拟器

Android模拟器中，使用特殊IP：

```kotlin
const val BASE_URL = "http://10.0.2.2:8000"
```

### 使用真机

1. 查看电脑IP地址：
   ```bash
   ipconfig
   ```
   找到 "无线局域网适配器 WLAN" 的 IPv4 地址，例如：`192.168.1.100`

2. 确保手机和电脑在同一WiFi网络

3. Android代码中使用电脑IP：
   ```kotlin
   const val BASE_URL = "http://192.168.1.100:8000"
   ```

4. 如果连接失败，检查Windows防火墙是否阻止了8000端口

## ⚠️ 常见问题

### 1. 端口被占用

**错误信息：**
```
[Errno 10048] error while attempting to bind on address
```

**解决方法：**
```bash
# 更换端口
uvicorn app.main:app --reload --port 8001
```

### 2. API Key未设置

**错误信息：**
```
服务配置错误: 未设置DASHSCOPE_API_KEY环境变量
```

**解决方法：**
1. 确认已创建 `.env` 文件
2. 确认API Key正确复制
3. 重启服务

### 3. 依赖安装失败

**解决方法：**
```bash
# 升级pip
python -m pip install --upgrade pip

# 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 4. 虚拟环境激活失败

**Windows PowerShell错误：**
```
无法加载文件，因为在此系统上禁止运行脚本
```

**解决方法：**
```powershell
# 以管理员身份运行PowerShell
Set-ExecutionPolicy RemoteSigned

# 或使用cmd而不是PowerShell
```

### 5. 真机无法连接

**解决方法：**
1. 确认手机和电脑在同一WiFi
2. 在Windows防火墙中允许Python通过：
   - 控制面板 → Windows Defender 防火墙 → 允许应用通过防火墙
   - 找到Python，勾选"专用"和"公用"
3. 或临时关闭防火墙测试

## 📊 查看日志

服务运行时会在终端显示日志：

```
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

API调用时也会显示：
```
INFO:     127.0.0.1:52341 - "POST /api/food/analyze HTTP/1.1" 200 OK
```

## 🎉 成功标志

如果看到以下响应，说明一切正常：

```json
{
  "success": true,
  "message": "分析成功",
  "data": {
    "name": "番茄炒蛋",
    "calories": 150.0,
    "protein": 10.5,
    "fat": 8.2,
    "carbs": 6.3,
    "recommendation": "这道菜营养均衡，蛋白质含量较高，适合减脂期食用。建议控制油量。"
  }
}
```

## 📞 需要帮助？

- 查看 `README.md` 了解更多详情
- 查看终端日志找出错误原因
- 确保Python版本 ≥ 3.10

