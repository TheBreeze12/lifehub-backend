# æ•°æ®åº“è¿æ¥æŒ‡å—

## ğŸ“‹ å‰ç½®å‡†å¤‡

### 1. å®‰è£…MySQLæ•°æ®åº“

**Windows:**
- ä¸‹è½½ï¼šhttps://dev.mysql.com/downloads/mysql/
- æˆ–ä½¿ç”¨XAMPPï¼šhttps://www.apachefriends.org/

**macOS:**
```bash
brew install mysql
brew services start mysql
```

**Linux (Ubuntu):**
```bash
sudo apt update
sudo apt install mysql-server
sudo systemctl start mysql
```

### 2. åˆ›å»ºæ•°æ®åº“

```sql
-- ç™»å½•MySQL
mysql -u root -p

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE lifehub CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- æŸ¥çœ‹æ•°æ®åº“
SHOW DATABASES;
```

---

## âš™ï¸ é…ç½®ç¯å¢ƒå˜é‡

### 1. å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿

```bash
# Windows
copy env_example.txt .env

# Linux/macOS
cp env_example.txt .env
```

### 2. ç¼–è¾‘ `.env` æ–‡ä»¶

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost          # æ•°æ®åº“ä¸»æœºï¼ˆæœ¬åœ°ç”¨localhostï¼‰
DB_PORT=3306              # MySQLç«¯å£ï¼ˆé»˜è®¤3306ï¼‰
DB_USER=root              # æ•°æ®åº“ç”¨æˆ·å
DB_PASSWORD=your_password # æ•°æ®åº“å¯†ç ï¼ˆæ›¿æ¢ä¸ºä½ çš„å¯†ç ï¼‰
DB_NAME=lifehub           # æ•°æ®åº“åç§°
```

**ç¤ºä¾‹ï¼š**
```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=lifehub
```

---

## ğŸ“¦ å®‰è£…ä¾èµ–

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
venv\Scripts\activate  # Windows
source venv/bin/activate  # Linux/macOS

# å®‰è£…æ–°ä¾èµ–
pip install -r requirements.txt
```

**æ–°å¢çš„ä¾èµ–åŒ…ï¼š**
- `sqlalchemy==2.0.25` - ORMæ¡†æ¶
- `pymysql==1.1.0` - MySQLé©±åŠ¨
- `cryptography==42.0.0` - åŠ å¯†æ”¯æŒ

---

## ğŸš€ åˆå§‹åŒ–æ•°æ®åº“

### æ–¹å¼ä¸€ï¼šè¿è¡Œåˆå§‹åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
python init_database.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
==================================================
ğŸ“¦ æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
==================================================
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼

ğŸ“ å¼€å§‹åˆ›å»ºæ•°æ®è¡¨...
âœ… æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸï¼

âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼

å·²åˆ›å»ºçš„è¡¨ï¼š
  - user (ç”¨æˆ·è¡¨)
  - diet_record (é¥®é£Ÿè®°å½•è¡¨)
  - trip_plan (è¡Œç¨‹è®¡åˆ’è¡¨)
  - trip_item (è¡Œç¨‹èŠ‚ç‚¹è¡¨)
```

### æ–¹å¼äºŒï¼šåœ¨ä»£ç ä¸­åˆå§‹åŒ–

```python
from app.database import init_db

# åˆå§‹åŒ–æ•°æ®åº“ï¼ˆåˆ›å»ºè¡¨ï¼‰
init_db()
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### 1. user - ç”¨æˆ·è¡¨

| å­—æ®µå            | ç±»å‹        | è¯´æ˜       |
| ----------------- | ----------- | ---------- |
| id                | INT         | ä¸»é”®ï¼Œè‡ªå¢ |
| nickname          | VARCHAR(50) | ç”¨æˆ·æ˜µç§°   |
| health_goal       | VARCHAR(20) | å¥åº·ç›®æ ‡   |
| allergens         | JSON        | è¿‡æ•åŸåˆ—è¡¨ |
| travel_preference | VARCHAR(20) | å‡ºè¡Œåå¥½   |
| daily_budget      | INT         | æ¯æ—¥é¢„ç®—   |
| created_at        | TIMESTAMP   | åˆ›å»ºæ—¶é—´   |
| updated_at        | TIMESTAMP   | æ›´æ–°æ—¶é—´   |

### 2. diet_record - é¥®é£Ÿè®°å½•è¡¨

| å­—æ®µå      | ç±»å‹         | è¯´æ˜         |
| ----------- | ------------ | ------------ |
| id          | INT          | ä¸»é”®ï¼Œè‡ªå¢   |
| user_id     | INT          | å¤–é”®ï¼Œç”¨æˆ·ID |
| food_name   | VARCHAR(100) | èœå“åç§°     |
| calories    | FLOAT        | çƒ­é‡         |
| protein     | FLOAT        | è›‹ç™½è´¨       |
| fat         | FLOAT        | è„‚è‚ª         |
| carbs       | FLOAT        | ç¢³æ°´åŒ–åˆç‰©   |
| meal_type   | VARCHAR(20)  | é¤æ¬¡         |
| record_date | DATE         | è®°å½•æ—¥æœŸ     |
| created_at  | TIMESTAMP    | åˆ›å»ºæ—¶é—´     |

### 3. trip_plan - è¡Œç¨‹è®¡åˆ’è¡¨

| å­—æ®µå      | ç±»å‹         | è¯´æ˜       |
| ----------- | ------------ | ---------- |
| id          | INT          | ä¸»é”®ï¼Œè‡ªå¢ |
| user_id     | INT          | ç”¨æˆ·ID     |
| title       | VARCHAR(100) | è¡Œç¨‹æ ‡é¢˜   |
| destination | VARCHAR(50)  | ç›®çš„åœ°     |
| start_date  | DATE         | å¼€å§‹æ—¥æœŸ   |
| end_date    | DATE         | ç»“æŸæ—¥æœŸ   |
| status      | VARCHAR(20)  | çŠ¶æ€       |
| created_at  | TIMESTAMP    | åˆ›å»ºæ—¶é—´   |

### 4. trip_item - è¡Œç¨‹èŠ‚ç‚¹è¡¨

| å­—æ®µå     | ç±»å‹         | è¯´æ˜         |
| ---------- | ------------ | ------------ |
| id         | INT          | ä¸»é”®ï¼Œè‡ªå¢   |
| trip_id    | INT          | å¤–é”®ï¼Œè¡Œç¨‹ID |
| day_index  | INT          | ç¬¬å‡ å¤©       |
| start_time | TIME         | å¼€å§‹æ—¶é—´     |
| place_name | VARCHAR(100) | åœ°ç‚¹åç§°     |
| place_type | VARCHAR(20)  | ç±»å‹         |
| duration   | INT          | æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ |
| cost       | FLOAT        | è´¹ç”¨         |
| notes      | TEXT         | å¤‡æ³¨         |

---

## ğŸ’» ä½¿ç”¨ç¤ºä¾‹

### 1. åœ¨è·¯ç”±ä¸­ä½¿ç”¨æ•°æ®åº“

```python
from fastapi import Depends
from sqlalchemy.orm import Session
from app.database import get_db
from app.db_models import User, DietRecord

@app.post("/api/user/create")
async def create_user(
    nickname: str,
    db: Session = Depends(get_db)  # ä¾èµ–æ³¨å…¥æ•°æ®åº“ä¼šè¯
):
    # åˆ›å»ºç”¨æˆ·
    new_user = User(nickname=nickname)
    db.add(new_user)
    db.commit()
    db.refresh(new_user)
    
    return {"id": new_user.id, "nickname": new_user.nickname}


@app.get("/api/user/{user_id}/diet-records")
async def get_diet_records(
    user_id: int,
    db: Session = Depends(get_db)
):
    # æŸ¥è¯¢ç”¨æˆ·çš„é¥®é£Ÿè®°å½•
    records = db.query(DietRecord).filter(
        DietRecord.user_id == user_id
    ).all()
    
    return {"records": records}
```

### 2. æ·»åŠ é¥®é£Ÿè®°å½•

```python
from datetime import date
from app.db_models import DietRecord

@app.post("/api/food/record")
async def add_diet_record(
    user_id: int,
    food_name: str,
    calories: float,
    db: Session = Depends(get_db)
):
    # åˆ›å»ºè®°å½•
    record = DietRecord(
        user_id=user_id,
        food_name=food_name,
        calories=calories,
        record_date=date.today()
    )
    
    db.add(record)
    db.commit()
    db.refresh(record)
    
    return {"success": True, "record_id": record.id}
```

### 3. æŸ¥è¯¢æ•°æ®

```python
# æŸ¥è¯¢å•ä¸ªç”¨æˆ·
user = db.query(User).filter(User.id == 1).first()

# æŸ¥è¯¢å¤šä¸ªè®°å½•
records = db.query(DietRecord).filter(
    DietRecord.user_id == 1,
    DietRecord.record_date == date.today()
).all()

# å…³è”æŸ¥è¯¢
trip = db.query(TripPlan).filter(TripPlan.id == 1).first()
items = trip.items  # è‡ªåŠ¨åŠ è½½å…³è”çš„è¡Œç¨‹èŠ‚ç‚¹
```

### 4. æ›´æ–°æ•°æ®

```python
# æ›´æ–°ç”¨æˆ·ä¿¡æ¯
user = db.query(User).filter(User.id == 1).first()
user.nickname = "æ–°æ˜µç§°"
user.health_goal = "reduce_fat"
db.commit()
```

### 5. åˆ é™¤æ•°æ®

```python
# åˆ é™¤è®°å½•
record = db.query(DietRecord).filter(DietRecord.id == 1).first()
db.delete(record)
db.commit()
```

---

## ğŸ” éªŒè¯æ•°æ®åº“è¿æ¥

### æ–¹å¼ä¸€ï¼šå¯åŠ¨åº”ç”¨æ—¶è‡ªåŠ¨æ£€æŸ¥

å¯åŠ¨FastAPIåº”ç”¨æ—¶ï¼Œä¼šè‡ªåŠ¨æ£€æŸ¥æ•°æ®åº“è¿æ¥ï¼š

```bash
python -m app.main
```

**è¾“å‡ºï¼š**
```
ğŸš€ åº”ç”¨å¯åŠ¨ä¸­...
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼
âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨æµ‹è¯•

```python
from app.database import check_db_connection

if check_db_connection():
    print("âœ… è¿æ¥æˆåŠŸ")
else:
    print("âŒ è¿æ¥å¤±è´¥")
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**
```
âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: (2003, "Can't connect to MySQL server")
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥MySQLæœåŠ¡æ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥ `.env` ä¸­çš„é…ç½®æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢è¿æ¥

### é—®é¢˜2: è®¤è¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**
```
âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: (1045, "Access denied for user")
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ç”¨æˆ·æœ‰è®¿é—®æ•°æ®åº“çš„æƒé™

### é—®é¢˜3: æ•°æ®åº“ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯ï¼š**
```
âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: (1049, "Unknown database 'lifehub'")
```

**è§£å†³æ–¹æ¡ˆï¼š**
```sql
CREATE DATABASE lifehub CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### é—®é¢˜4: è¡¨å·²å­˜åœ¨

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Table 'user' already exists
```

**è§£å†³æ–¹æ¡ˆï¼š**
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œè¯´æ˜è¡¨å·²ç»åˆ›å»ºè¿‡äº†
- å¦‚æœæƒ³é‡æ–°åˆ›å»ºï¼Œå…ˆåˆ é™¤è¡¨ï¼š
```sql
DROP TABLE trip_item;
DROP TABLE trip_plan;
DROP TABLE diet_record;
DROP TABLE user;
```
ç„¶åé‡æ–°è¿è¡Œ `init_database.py`

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. âœ… æ•°æ®åº“è¿æ¥é…ç½®å®Œæˆ
2. âœ… æ•°æ®è¡¨ç»“æ„å·²åˆ›å»º
3. â­ï¸ åœ¨APIè·¯ç”±ä¸­ä½¿ç”¨æ•°æ®åº“ï¼ˆè§ä½¿ç”¨ç¤ºä¾‹ï¼‰
4. â­ï¸ å®ç°ç”¨æˆ·æ³¨å†Œ/ç™»å½•åŠŸèƒ½
5. â­ï¸ å®ç°é¥®é£Ÿè®°å½•CRUD
6. â­ï¸ å®ç°è¡Œç¨‹è§„åˆ’CRUD

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [SQLAlchemyå®˜æ–¹æ–‡æ¡£](https://docs.sqlalchemy.org/)
- [FastAPIæ•°æ®åº“æ•™ç¨‹](https://fastapi.tiangolo.com/tutorial/sql-databases/)
- [é¡¹ç›®APIæ–‡æ¡£](APIæ–‡æ¡£.md)

