# åç«¯é¡¹ç›®è¯´æ˜

## ğŸ“¦ é¡¹ç›®æ¦‚è§ˆ

è¿™æ˜¯"æ™ºèƒ½ç”Ÿæ´»æœåŠ¡å·¥å…·"çš„åç«¯æœåŠ¡ï¼Œæä¾›åŸºäºAIçš„èœå“è¥å…»åˆ†æåŠŸèƒ½ã€‚

### æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: FastAPI 0.109.0
- **AIæœåŠ¡**: é˜¿é‡Œäº‘é€šä¹‰åƒé—® (DashScope)
- **Pythonç‰ˆæœ¬**: 3.10+
- **æœåŠ¡å™¨**: Uvicorn

### æ ¸å¿ƒåŠŸèƒ½
âœ… èœå“åç§° â†’ AIè¥å…»åˆ†æ â†’ è¿”å›çƒ­é‡ã€ä¸‰å¤§è¥å…»ç´ ã€æ¨èå»ºè®®

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app/                        # åº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                # FastAPIåº”ç”¨å…¥å£ â­
â”‚   â”‚   â””â”€â”€ é…ç½®CORSã€æ³¨å†Œè·¯ç”±ã€å¯åŠ¨æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ food.py           # é£Ÿç‰©ç›¸å…³æ•°æ®æ¨¡å‹ â­
â”‚   â”‚       â”œâ”€â”€ FoodRequest   # è¯·æ±‚ä½“
â”‚   â”‚       â”œâ”€â”€ FoodData      # è¥å…»æ•°æ®
â”‚   â”‚       â””â”€â”€ FoodResponse  # å“åº”ä½“
â”‚   â”‚
â”‚   â”œâ”€â”€ routers/              # APIè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ food.py           # é£Ÿç‰©APIè·¯ç”± â­
â”‚   â”‚       â”œâ”€â”€ POST /api/food/analyze
â”‚   â”‚       â””â”€â”€ GET  /api/food/health
â”‚   â”‚
â”‚   â””â”€â”€ services/             # ä¸šåŠ¡æœåŠ¡
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ ai_service.py     # AIæœåŠ¡å°è£… â­
â”‚           â”œâ”€â”€ analyze_food_nutrition()
â”‚           â””â”€â”€ è°ƒç”¨é€šä¹‰åƒé—®API
â”‚
â”œâ”€â”€ requirements.txt          # Pythonä¾èµ– â­
â”œâ”€â”€ env_example.txt          # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ start.bat                # Windowså¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_api.py              # APIæµ‹è¯•è„šæœ¬
â”œâ”€â”€ README.md                # å®Œæ•´è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ å¿«é€Ÿå¼€å§‹.md              # å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
â”œâ”€â”€ APIæ–‡æ¡£.md               # æ¥å£æ–‡æ¡£
â””â”€â”€ é¡¹ç›®è¯´æ˜.md              # æœ¬æ–‡ä»¶
```

---

## ğŸ¯ æ ¸å¿ƒä»£ç è§£æ

### 1. main.py - åº”ç”¨å…¥å£

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(title="æ™ºèƒ½ç”Ÿæ´»æœåŠ¡å·¥å…·API")

# é…ç½®CORS - å…è®¸Androidå®¢æˆ·ç«¯è·¨åŸŸè®¿é—®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ç”Ÿäº§ç¯å¢ƒéœ€é™åˆ¶
    allow_methods=["*"],
    allow_headers=["*"],
)

# æ³¨å†Œè·¯ç”±
app.include_router(food_router)
```

### 2. models/food.py - æ•°æ®æ¨¡å‹

```python
from pydantic import BaseModel

class FoodRequest(BaseModel):
    """è¯·æ±‚ï¼šèœå“åç§°"""
    food_name: str

class FoodData(BaseModel):
    """è¥å…»æ•°æ®"""
    name: str
    calories: float
    protein: float
    fat: float
    carbs: float
    recommendation: str

class FoodResponse(BaseModel):
    """å“åº”ï¼šåŒ…å«successæ ‡å¿—å’Œæ•°æ®"""
    success: bool
    data: FoodData | None
```

### 3. services/ai_service.py - AIè°ƒç”¨

```python
import dashscope
from dashscope import Generation

class AIService:
    def analyze_food_nutrition(self, food_name: str) -> dict:
        """è°ƒç”¨é€šä¹‰åƒé—®åˆ†æè¥å…»"""
        
        # æ„å»ºPrompt
        prompt = f"""
        åˆ†æ"{food_name}"çš„è¥å…»æˆåˆ†ï¼Œè¿”å›JSONï¼š
        {{
            "calories": çƒ­é‡,
            "protein": è›‹ç™½è´¨,
            "fat": è„‚è‚ª,
            "carbs": ç¢³æ°´,
            "recommendation": "æ¨èå»ºè®®"
        }}
        """
        
        # è°ƒç”¨API
        response = Generation.call(
            model="qwen-turbo",
            prompt=prompt
        )
        
        # è§£æè¿”å›
        return parse_response(response)
```

### 4. routers/food.py - APIè·¯ç”±

```python
from fastapi import APIRouter

router = APIRouter(prefix="/api/food")
ai_service = AIService()

@router.post("/analyze")
async def analyze_food(request: FoodRequest):
    """åˆ†æèœå“"""
    data = ai_service.analyze_food_nutrition(request.food_name)
    return FoodResponse(success=True, data=FoodData(**data))
```

---

## ğŸ”„ è¯·æ±‚æµç¨‹

```
Androidå®¢æˆ·ç«¯
    â”‚
    â”‚ POST /api/food/analyze
    â”‚ {"food_name": "ç•ªèŒ„ç‚’è›‹"}
    â–¼
FastAPI (routers/food.py)
    â”‚
    â”‚ è°ƒç”¨ AIService
    â–¼
AIService (services/ai_service.py)
    â”‚
    â”‚ æ„å»ºPrompt
    â”‚ è°ƒç”¨é€šä¹‰åƒé—®API
    â–¼
é€šä¹‰åƒé—®äº‘æœåŠ¡
    â”‚
    â”‚ è¿”å›JSONæ ¼å¼è¥å…»æ•°æ®
    â–¼
AIService
    â”‚
    â”‚ è§£æJSON
    â–¼
FastAPI
    â”‚
    â”‚ å°è£…ä¸ºFoodResponse
    â”‚ {"success": true, "data": {...}}
    â–¼
Androidå®¢æˆ·ç«¯
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡ (.env)

```
DASHSCOPE_API_KEY=sk-xxxxxxxx    # å¿…éœ€ï¼šé€šä¹‰åƒé—®API Key
HOST=0.0.0.0                     # å¯é€‰ï¼šç›‘å¬åœ°å€
PORT=8000                        # å¯é€‰ï¼šç«¯å£å·
```

### ä¾èµ–åŒ… (requirements.txt)

| åŒ…å          | ç‰ˆæœ¬    | è¯´æ˜         |
| ------------- | ------- | ------------ |
| fastapi       | 0.109.0 | Webæ¡†æ¶      |
| uvicorn       | 0.27.0  | ASGIæœåŠ¡å™¨   |
| pydantic      | 2.5.3   | æ•°æ®éªŒè¯     |
| dashscope     | 1.14.1  | é€šä¹‰åƒé—®SDK  |
| python-dotenv | 1.0.0   | ç¯å¢ƒå˜é‡åŠ è½½ |

---

## ğŸš€ å¯åŠ¨æ–¹å¼

### æ–¹å¼ä¸€ï¼šä¸€é”®å¯åŠ¨ï¼ˆæ¨èï¼‰
```bash
# Windows
åŒå‡» start.bat
```

### æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œ
```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
venv\Scripts\activate

# å¯åŠ¨æœåŠ¡
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### æ–¹å¼ä¸‰ï¼šPythonæ¨¡å—
```bash
python -m app.main
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. æµè§ˆå™¨è®¿é—®APIæ–‡æ¡£
```
http://localhost:8000/docs
```

### 2. è¿è¡Œæµ‹è¯•è„šæœ¬
```bash
python test_api.py
```

### 3. curlå‘½ä»¤
```bash
curl -X POST http://localhost:8000/api/food/analyze \
  -H "Content-Type: application/json" \
  -d '{"food_name": "ç•ªèŒ„ç‚’è›‹"}'
```

---

## ğŸ“± Androidè¿æ¥

### æ¨¡æ‹Ÿå™¨
```kotlin
const val BASE_URL = "http://10.0.2.2:8000"
```

### çœŸæœº
```kotlin
// æ›¿æ¢ä¸ºç”µè„‘çš„å®é™…IP
const val BASE_URL = "http://192.168.1.100:8000"
```

---

## ğŸ› ï¸ å¼€å‘å»ºè®®

### æ·»åŠ åŠŸèƒ½

1. **æ·»åŠ æ–°çš„APIæ¥å£**
   - åœ¨ `routers/` ä¸‹åˆ›å»ºæ–°æ–‡ä»¶
   - åœ¨ `main.py` ä¸­æ³¨å†Œè·¯ç”±

2. **æ·»åŠ æ–°çš„AIåŠŸèƒ½**
   - åœ¨ `services/ai_service.py` ä¸­æ·»åŠ æ–¹æ³•
   - è®¾è®¡å¥½Prompt

3. **æ·»åŠ æ•°æ®æ¨¡å‹**
   - åœ¨ `models/` ä¸‹åˆ›å»ºæ–°æ–‡ä»¶
   - ä½¿ç”¨Pydanticå®šä¹‰

### ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ ç¼“å­˜**
   ```python
   from functools import lru_cache
   
   @lru_cache(maxsize=100)
   def cached_analyze(food_name):
       return ai_service.analyze_food_nutrition(food_name)
   ```

2. **æ·»åŠ æ—¥å¿—**
   ```python
   import logging
   
   logging.basicConfig(level=logging.INFO)
   logger = logging.getLogger(__name__)
   logger.info(f"åˆ†æé£Ÿç‰©: {food_name}")
   ```

3. **å¼‚å¸¸å¤„ç†**
   ```python
   try:
       result = ai_service.analyze_food_nutrition(food_name)
   except Exception as e:
       logger.error(f"åˆ†æå¤±è´¥: {str(e)}")
       raise HTTPException(status_code=500, detail=str(e))
   ```

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### å“åº”æ—¶é—´
- é¦–æ¬¡è°ƒç”¨ï¼š3-5ç§’ï¼ˆAIåˆ†æï¼‰
- åç»­è°ƒç”¨ï¼šå»ºè®®æ·»åŠ ç¼“å­˜

### å¹¶å‘å¤„ç†
- FastAPIåŸºäºå¼‚æ­¥ï¼Œæ”¯æŒé«˜å¹¶å‘
- é€šä¹‰åƒé—®æœ‰QPSé™åˆ¶

### ä¼˜åŒ–æ–¹å‘
1. æ·»åŠ Redisç¼“å­˜å¸¸è§èœå“
2. ä½¿ç”¨æ•°æ®åº“å­˜å‚¨åˆ†æå†å²
3. æ‰¹é‡åˆ†ææ¥å£

---

## ğŸ” å®‰å…¨å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

1. **é™åˆ¶CORSæ¥æº**
   ```python
   allow_origins=["https://your-domain.com"]
   ```

2. **æ·»åŠ è®¤è¯**
   ```python
   from fastapi.security import HTTPBearer
   ```

3. **API Keyä¿æŠ¤**
   - ä¸è¦æäº¤ `.env` æ–‡ä»¶åˆ°Git
   - ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡

4. **è¯·æ±‚é™æµ**
   - ä½¿ç”¨slowapiç­‰åº“

---

## ğŸ“ ä¸‹ä¸€æ­¥å¼€å‘

- [ ] æ·»åŠ ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- [ ] å®ç°æŸ¥è¯¢å†å²è®°å½•
- [ ] æ·»åŠ Redisç¼“å­˜
- [ ] å®ç°æ‰¹é‡åˆ†æ
- [ ] æ·»åŠ å‡ºè¡Œè§„åˆ’API
- [ ] éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨

---

## ğŸ†˜ é—®é¢˜æ’æŸ¥

### é—®é¢˜1: æœåŠ¡å¯åŠ¨å¤±è´¥
- æ£€æŸ¥Pythonç‰ˆæœ¬ï¼ˆéœ€è¦3.10+ï¼‰
- æ£€æŸ¥ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—

### é—®é¢˜2: APIè°ƒç”¨500é”™è¯¯
- æ£€æŸ¥ `.env` æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹åç«¯æ—¥å¿—è¾“å‡º

### é—®é¢˜3: Androidæ— æ³•è¿æ¥
- æ¨¡æ‹Ÿå™¨ä½¿ç”¨ `10.0.2.2`
- çœŸæœºæ£€æŸ¥IPå’Œé˜²ç«å¢™
- ç¡®è®¤æœåŠ¡å·²å¯åŠ¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](README.md) - å®Œæ•´è¯´æ˜æ–‡æ¡£
- [å¿«é€Ÿå¼€å§‹.md](å¿«é€Ÿå¼€å§‹.md) - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
- [APIæ–‡æ¡£.md](APIæ–‡æ¡£.md) - æ¥å£è¯¦ç»†æ–‡æ¡£

---

## ğŸ‘¨â€ğŸ’» å¼€å‘è€…

è½¯ä»¶åˆ›æ–°å¤§èµ›å‚èµ›ä½œå“ - æ™ºèƒ½ç”Ÿæ´»æœåŠ¡å·¥å…·

