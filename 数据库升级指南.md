# LifeHub 数据库升级指南

## 问题诊断

如果你在测试时遇到以下错误，说明数据库版本过旧：

- `Unknown column 'weight' in 'field list'`
- `Unknown column 'height' in 'field list'`
- `Table 'lifehub.meal_comparison' doesn't exist`
- 用户偏好相关接口返回500错误

## 解决方案

### 方案一：增量升级（推荐，保留现有数据）

按顺序执行以下SQL迁移脚本：

```bash
# 1. 登录MySQL
mysql -u root -p

# 2. 选择数据库
USE lifehub;

# 3. 执行Phase 4迁移（添加身体参数字段）
SOURCE migrations/phase4_add_body_params.sql;

# 4. 执行Phase 10迁移（创建餐前餐后对比表）
SOURCE migrations/phase10_meal_comparison.sql;
```

或者手动执行以下SQL：

```sql
-- Phase 4: 添加身体参数字段到user表
ALTER TABLE `user` ADD COLUMN `weight` FLOAT DEFAULT NULL COMMENT '体重（kg）' AFTER `daily_budget`;
ALTER TABLE `user` ADD COLUMN `height` FLOAT DEFAULT NULL COMMENT '身高（cm）' AFTER `weight`;
ALTER TABLE `user` ADD COLUMN `age` INT DEFAULT NULL COMMENT '年龄' AFTER `height`;
ALTER TABLE `user` ADD COLUMN `gender` VARCHAR(10) DEFAULT NULL COMMENT '性别: male/female/other' AFTER `age`;

-- Phase 10: 创建餐前餐后对比表
CREATE TABLE IF NOT EXISTS `meal_comparison` (
    `id` INT AUTO_INCREMENT PRIMARY KEY COMMENT '对比记录ID',
    `user_id` INT NOT NULL COMMENT '用户ID',
    `before_image_url` VARCHAR(500) COMMENT '餐前图片URL/路径',
    `before_features` TEXT COMMENT '餐前图片特征（JSON格式）',
    `after_image_url` VARCHAR(500) COMMENT '餐后图片URL/路径',
    `after_features` TEXT COMMENT '餐后图片特征（JSON格式）',
    `consumption_ratio` FLOAT COMMENT '消耗比例（0-1，1表示全部吃完）',
    `original_calories` FLOAT COMMENT '原始估算热量（kcal）',
    `net_calories` FLOAT COMMENT '净摄入热量（kcal）',
    `original_protein` FLOAT COMMENT '原始蛋白质（g）',
    `original_fat` FLOAT COMMENT '原始脂肪（g）',
    `original_carbs` FLOAT COMMENT '原始碳水化合物（g）',
    `net_protein` FLOAT COMMENT '净摄入蛋白质（g）',
    `net_fat` FLOAT COMMENT '净摄入脂肪（g）',
    `net_carbs` FLOAT COMMENT '净摄入碳水化合物（g）',
    `status` VARCHAR(20) DEFAULT 'pending_before' COMMENT '状态: pending_before/pending_after/completed',
    `comparison_analysis` TEXT COMMENT 'AI对比分析说明',
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    CONSTRAINT `fk_meal_comparison_user` FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE,
    INDEX `idx_meal_comparison_user_id` (`user_id`),
    INDEX `idx_meal_comparison_status` (`status`),
    INDEX `idx_meal_comparison_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='餐前餐后对比表';
```

### 方案二：全新安装（会清空所有数据）

如果不需要保留现有数据，可以使用最新的DDL重建：

```bash
# 1. 登录MySQL
mysql -u root -p

# 2. 删除旧数据库
DROP DATABASE IF EXISTS lifehub;

# 3. 执行最新DDL
SOURCE create_db.sql;
```

## 验证升级成功

升级后，运行测试脚本验证数据库结构：

```bash
# 激活conda环境并运行测试
conda run -n software_contest python test/test_database_schema.py
```

应该看到输出：
```
✅ 数据库结构验证通过，所有Phase 1-11的表和字段都存在
```

## 数据库版本对照表

| Phase | 变更内容 | 迁移脚本 |
|-------|---------|---------|
| Phase 4 | user表添加weight, height, age, gender字段 | `migrations/phase4_add_body_params.sql` |
| Phase 10 | 新增meal_comparison表 | `migrations/phase10_meal_comparison.sql` |

## 当前最新表结构

| 表名 | 说明 |
|------|------|
| `user` | 用户表（含身体参数） |
| `diet_record` | 饮食记录表 |
| `menu_recognition` | 菜单识别表 |
| `trip_plan` | 运动计划表 |
| `trip_item` | 运动项目表 |
| `meal_comparison` | 餐前餐后对比表 |

## 联系

如有问题，请联系项目负责人。
